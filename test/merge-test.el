(ert-deftest merge-analysis-ff ()
  (let (id)
    (with-temp-dir path
      (init)
      (commit-change "a" "abcdef")
      (run "git" "checkout" "-b" "newbranch")
      (commit-change "a" "ghijkl")
      (commit-change "a" "mnopqrs")
      (run "git" "checkout" "master")
      (let* ((repo (libgit-repository-open path))
             (ref (libgit-reference-dwim repo "newbranch"))
             (ann (libgit-annotated-commit-from-ref repo ref)))
        (should (equal '((normal fastforward) . nil)
                       (libgit-merge-analysis repo (list ann))))))))

(ert-deftest merge-analysis-up-to-date ()
  (let (id)
    (with-temp-dir path
      (init)
      (commit-change "a" "abcdef")
      (run "git" "checkout" "-b" "newbranch")
      (run "git" "checkout" "master")
      (let* ((repo (libgit-repository-open path))
             (ref (libgit-reference-dwim repo "newbranch"))
             (ann (libgit-annotated-commit-from-ref repo ref)))
        (should (equal '((up-to-date) . nil)
                       (libgit-merge-analysis repo (list ann))))))))

(ert-deftest merge-analysis-normal ()
  (let (id)
    (with-temp-dir path
      (init)
      (commit-change "a" "abcdef")
      (run "git" "checkout" "-b" "newbranch")
      (commit-change "a" "ghijkl")
      (run "git" "checkout" "master")
      (commit-change "a" "mnopqrs")
      (let* ((repo (libgit-repository-open path))
             (ref (libgit-reference-dwim repo "newbranch"))
             (ann (libgit-annotated-commit-from-ref repo ref)))
        (should (equal '((normal) . nil)
                       (libgit-merge-analysis repo (list ann))))))))

(ert-deftest merge-analysis-preference ()
  (let (id)
    (with-temp-dir path
      (init)
      (commit-change "a" "abcdef")
      (run "git" "checkout" "-b" "newbranch")
      (commit-change "a" "ghijkl")
      (run "git" "checkout" "master")
      (commit-change "a" "mnopqrs")
      (let* ((repo (libgit-repository-open path))
             (config (libgit-repository-config repo))
             (ref (libgit-reference-dwim repo "newbranch"))
             (ann (libgit-annotated-commit-from-ref repo ref)))
        (let ((trans (libgit-config-lock config)))
          (libgit-config-set-bool config "merge.ff" nil)
          (libgit-transaction-commit trans))
        (should (equal '((normal) . no-fastforward)
                       (libgit-merge-analysis repo (list ann))))
        (let ((trans (libgit-config-lock config)))
          (libgit-config-set-string config "merge.ff" "only")
          (libgit-transaction-commit trans))
        (should (equal '((normal) . fastforward-only)
                       (libgit-merge-analysis repo (list ann))))))))

(ert-deftest merge-base ()
  (let (id)
    (with-temp-dir path
      (init)
      (commit-change "a" "abcdef")
      (setq id (run-nnl "git" "rev-parse" "HEAD"))
      (run "git" "checkout" "-b" "newbranch")
      (commit-change "a" "ghijkl")
      (run "git" "checkout" "master")
      (commit-change "a" "mnopqrs")
      (let* ((repo (libgit-repository-open path))
             (id1 (libgit-reference-name-to-id repo "refs/heads/master"))
             (id2 (libgit-reference-name-to-id repo "refs/heads/newbranch")))
        (should (string= id (libgit-merge-base repo (list id1 id2))))))))

(ert-deftest merge-base-octopus ()
  (let (id)
    (with-temp-dir path
      (init)
      (commit-change "a" "abcdef")
      (setq id (run-nnl "git" "rev-parse" "HEAD"))
      (run "git" "checkout" "-b" "newbranch")
      (commit-change "a" "ghijkl")
      (run "git" "checkout" "master")
      (run "git" "checkout" "-b" "otherbranch")
      (commit-change "a" "mnopqr")
      (run "git" "checkout" "master")
      (commit-change "a" "tuvwxy")
      (let* ((repo (libgit-repository-open path))
             (id1 (libgit-reference-name-to-id repo "refs/heads/master"))
             (id2 (libgit-reference-name-to-id repo "refs/heads/newbranch"))
             (id3 (libgit-reference-name-to-id repo "refs/heads/otherbranch")))
        (should (string= id (libgit-merge-base-octopus repo (list id1 id2 id3))))
        (should (string= id (libgit-merge-base repo (list id1 id2 id3))))))))

(ert-deftest merge-bases ()
  (let (id)
    (with-temp-dir path
      (init)
      (commit-change "a" "abcdef")
      (commit-change "a" "ghijkl")
      (commit-change "a" "mnopqrs")
      (setq id (run-nnl "git" "rev-parse" "HEAD"))
      (run "git" "checkout" "-b" "newbranch")
      (commit-change "a" "tuvwxy")
      (run "git" "checkout" "master")
      (commit-change "a" "123456")
      (let* ((repo (libgit-repository-open path))
             (id1 (libgit-reference-name-to-id repo "refs/heads/master"))
             (id2 (libgit-reference-name-to-id repo "refs/heads/newbranch")))
        (should (equal (list id)
                       (libgit-merge-bases repo (list id1 id2))))))))
